name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}

    outputs:
      version: ${{ steps.version.outputs.version }}
      has_changes: ${{ steps.version.outputs.has_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine version bump type
        id: bump_type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=${{ inputs.version_type }}" >> $GITHUB_OUTPUT
          else
            # Check commit messages since last tag
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -z "$LAST_TAG" ]; then
              COMMITS=$(git log --pretty=format:"%s")
            else
              COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s")
            fi

            if echo "$COMMITS" | grep -qE "^(BREAKING CHANGE:|feat!:|fix!:)"; then
              echo "type=major" >> $GITHUB_OUTPUT
            elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
              echo "type=minor" >> $GITHUB_OUTPUT
            elif echo "$COMMITS" | grep -qE "^fix(\(.+\))?:"; then
              echo "type=patch" >> $GITHUB_OUTPUT
            else
              echo "type=none" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Bump version
        id: version
        run: |
          BUMP_TYPE="${{ steps.bump_type.outputs.type }}"

          if [ "$BUMP_TYPE" == "none" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No version bump needed - no conventional commits found"
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Bump version in package.json
          npm version $BUMP_TYPE --no-git-tag-version

          # Get new version
          NEW_VERSION=$(node -p "require('./package.json').version")

          # Update Tauri config
          sed -i.bak "s/\"version\": \".*\"/\"version\": \"$NEW_VERSION\"/" src-tauri/tauri.conf.json
          rm -f src-tauri/tauri.conf.json.bak

          # Update Cargo.toml
          sed -i.bak "s/^version = \".*\"/version = \"$NEW_VERSION\"/" src-tauri/Cargo.toml
          rm -f src-tauri/Cargo.toml.bak

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

          # Stage changes
          git add package.json src-tauri/tauri.conf.json src-tauri/Cargo.toml

          # Check if there are actual changes to commit
          if git diff --staged --quiet; then
            echo "No version changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Commit and tag (force tag if it exists)
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]"

          # Delete tag if it exists and create new one
          if git rev-parse "v$NEW_VERSION" >/dev/null 2>&1; then
            echo "Tag v$NEW_VERSION already exists, deleting old tag"
            git tag -d "v$NEW_VERSION"
            git push origin :refs/tags/v$NEW_VERSION || true
          fi

          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"

      - name: Push changes
        if: steps.version.outputs.has_changes == 'true'
        run: |
          git push origin main --follow-tags

  build-and-release:
    needs: version-bump
    if: needs.version-bump.outputs.has_changes == 'true'
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target universal-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
          - platform: 'windows-latest'
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.version-bump.outputs.version }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: npm ci

      - name: Install create-dmg (macOS only)
        if: matrix.platform == 'macos-latest'
        run: brew install create-dmg

      - name: Build and release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v${{ needs.version-bump.outputs.version }}
          releaseName: 'Vaulty v${{ needs.version-bump.outputs.version }}'
          releaseBody: 'See the changelog for details about this release.'
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}

      - name: Create DMG manually (macOS fallback)
        if: matrix.platform == 'macos-latest'
        run: |
          VERSION="${{ needs.version-bump.outputs.version }}"
          # Find the .app bundle
          APP_PATH=$(find src-tauri/target -name "*.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            DMG_NAME="Vaulty_${VERSION}_universal.dmg"
            create-dmg \
              --volname "Vaulty" \
              --window-pos 200 120 \
              --window-size 600 400 \
              --icon-size 100 \
              --icon "$(basename $APP_PATH)" 175 190 \
              --hide-extension "$(basename $APP_PATH)" \
              --app-drop-link 425 190 \
              "$DMG_NAME" \
              "$APP_PATH" || echo "DMG already created by tauri-action"
          fi

  generate-update-manifest:
    needs: [version-bump, build-and-release]
    if: needs.version-bump.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Generate update manifest
        run: |
          VERSION="${{ needs.version-bump.outputs.version }}"

          cat > latest.json << EOF
          {
            "version": "v$VERSION",
            "notes": "See the full changelog at https://github.com/${{ github.repository }}/releases/tag/v$VERSION",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "darwin-x86_64": {
                "signature": "",
                "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/Vaulty_${VERSION}_x64.app.tar.gz"
              },
              "darwin-aarch64": {
                "signature": "",
                "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/Vaulty_${VERSION}_aarch64.app.tar.gz"
              },
              "linux-x86_64": {
                "signature": "",
                "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/vaulty_${VERSION}_amd64.AppImage.tar.gz"
              },
              "windows-x86_64": {
                "signature": "",
                "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/Vaulty_${VERSION}_x64-setup.nsis.zip"
              }
            }
          }
          EOF

      - name: Upload manifest to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version-bump.outputs.version }}
          files: latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
